<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒã‚¤ã‹ã‚“</title>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; background: #fffbe7; color: #333; }
input, button { width: 100%; padding: 6px; margin: 4px 0; }
h1, h2 { text-align: center; }
#currentDate { text-align: center; font-size: 14px; margin-bottom: 10px; }
#status { margin: 10px 0; color: green; text-align: center; }
#settingsBtn, #closeSettingsBtn { position: fixed; top:5px; right:0; font-size:14px; padding:8px 12px; background:#f7941d; color:#fff; border:none; border-radius:6px; z-index:1000; }
#closeSettingsBtn { display:none; }
#settingsPanel { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#fffbe7; overflow-y:auto; z-index:999; }
#settingsContent { max-width:700px; margin:auto; padding:20px; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th,td { border:1px solid #ccc; padding:6px; text-align:center; }
</style>
</head>
<body>
<h2>ãƒã‚¤ãƒ³ãƒˆåˆ¸ã‚’ã‚‚ã†å…¨éƒ¨æ•°ãˆãªãã¦ã„ã„ï¼</h2>
<h1>ãƒã‚¤ã‹ã‚“</h1>
<div id="currentDate"></div>
<div id="loginSection">
  <input id="userNumber" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç•ªå·">
  <button onclick="signIn()">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button onclick="signUp()">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
</div>
<div id="mainSection" style="display:none;">
  <button id="settingsBtn" onclick="toggleSettings(true)">è¨­å®š</button>
  <div>
    <strong>ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°:</strong> <span id="ticketCount">0</span><br>
    <strong>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ:</strong> <span id="totalPoints">0</span> pt
  </div>
  <label>ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°:</label>
  <input type="number" id="usedTickets" value="0">
  <label>è¿½åŠ ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°:</label>
  <input type="number" id="addedTickets" value="0">
  <button onclick="updateTickets()">ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²</button>
  <table>
    <thead>
      <tr>
        <th>æ—¥ä»˜</th>
        <th>ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°</th>
        <th>è¿½åŠ ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°</th>
        <th>åˆè¨ˆåˆ¸</th>
        <th>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</th>
      </tr>
    </thead>
    <tbody id="historyList"></tbody>
  </table>
  <button style="margin-top:20px;" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<div id="settingsPanel">
  <div id="settingsContent">
    <button id="closeSettingsBtn" onclick="toggleSettings(false)">æˆ»ã‚‹</button>
    <h1>è¨­å®š</h1>
    <label>æ—¥ä»˜:</label>
    <input type="date" id="manualDate">
    <label>ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°:</label>
    <input type="number" id="manualUsedTickets" value="0">
    <label>è¿½åŠ ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°:</label>
    <input type="number" id="manualAddedTickets" value="0">
    <button onclick="addManualEntry()">+ è¨˜éŒ²ã‚’è¿½åŠ </button>
    <hr>
    <label>å‰Šé™¤ã™ã‚‹æ—¥ä»˜:</label>
    <input type="date" id="deleteDate">
    <button onclick="deleteEntry()">Ã— è¨˜éŒ²ã‚’å‰Šé™¤</button>
    <hr>
    <button onclick="deleteAccount()" style="background:#d9534f;">ğŸ—‘ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
  </div>
</div>

<div id="status"></div>

<script>
// âœ… ã‚ãªãŸã®API URL
const apiUrl = "https://script.google.com/macros/s/AKfycbz4jx06-o-_gwy3fRXTZIJ1pjbuZjq7-vl-izjb4N-TjOaZiU4TEQO7itxQDdtZYWE/exec";

let currentUser = "";
let ticketCount = 0;
let history = [];

function getTodayJST(){
  const now = new Date();
  now.setHours(now.getHours() + 9);
  return now.toISOString().split("T")[0];
}

document.getElementById("currentDate").textContent = "ä»Šæ—¥ã®æ—¥ä»˜: " + getTodayJST();
document.getElementById("manualDate").setAttribute("max", getTodayJST());
document.getElementById("deleteDate").setAttribute("max", getTodayJST());

function signIn(){
  const user = document.getElementById("userNumber").value.trim();
  if(!user){
    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  fetch(apiUrl + "?user=" + encodeURIComponent(user))
  .then(res => res.text())
  .then(txt=>{
    currentUser = user;
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("mainSection").style.display = "block";
    if(txt && txt !== "{}"){
      const data = JSON.parse(txt);
      history = data.history || [];
    } else {
      history = [];
    }
    saveData();
    document.getElementById("status").textContent = "ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸ";
  });
}

function signUp(){
  const user = document.getElementById("userNumber").value.trim();
  if(!user){
    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  if(!confirm("æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")){
    return;
  }
  currentUser = user;
  history = [];
  saveData();
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("mainSection").style.display = "block";
  document.getElementById("status").textContent = "ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼ˆæ–°è¦ä½œæˆï¼‰";
}

function saveToServer(){
  if(!currentUser) return;
  const content = JSON.stringify({history});
  fetch(apiUrl + "?user=" + encodeURIComponent(currentUser) + "&mode=save",{
    method:"POST",
    body:content
  })
  .then(res=>res.text())
  .then(()=>{document.getElementById("status").textContent="ä¿å­˜ã—ã¾ã—ãŸ";});
}

function updateDisplay(){
  document.getElementById("ticketCount").textContent = ticketCount;
  document.getElementById("totalPoints").textContent = ticketCount*5;
}

function rebuildTicketCount(){
  ticketCount=0;
  history.sort((a,b)=>a.time.localeCompare(b.time));
  history.forEach(e=>{
    ticketCount+=e.added - e.used;
    e.total = ticketCount;
  });
}

function saveData(){
  rebuildTicketCount();
  updateDisplay();
  refreshHistory();
  saveToServer();
}

function updateTickets(){
  const used = parseInt(document.getElementById("usedTickets").value)||0;
  const added = parseInt(document.getElementById("addedTickets").value)||0;
  if(used===0 && added===0){
    alert("ä½¿ç”¨ã¾ãŸã¯è¿½åŠ ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  const now = getTodayJST();
  const idx = history.findIndex(e=>e.time===now);
  const entry = {time:now, used, added};
  if(idx!==-1) history[idx]=entry;
  else history.push(entry);
  saveData();
}

function addManualEntry(){
  const time = document.getElementById("manualDate").value;
  if(!time){ alert("æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
  const today=getTodayJST();
  if(time>today){ alert("ä»Šæ—¥ã‚ˆã‚Šå¾Œã®æ—¥ä»˜ã¯é¸ã¹ã¾ã›ã‚“"); return; }
  const used=parseInt(document.getElementById("manualUsedTickets").value)||0;
  const added=parseInt(document.getElementById("manualAddedTickets").value)||0;
  if(used===0 && added===0){
    alert("ä½¿ç”¨ã¾ãŸã¯è¿½åŠ ãƒã‚¤ãƒ³ãƒˆåˆ¸æšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  const idx=history.findIndex(e=>e.time===time);
  const entry={time, used, added};
  if(idx!==-1)history[idx]=entry;
  else history.push(entry);
  saveData();
}

function deleteEntry(){
  const delTime = document.getElementById("deleteDate").value;
  const index = history.findIndex(e=>e.time===delTime);
  if(index===-1){
    alert("ãã®æ—¥ä»˜ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }
  history.splice(index,1);
  saveData();
}

function deleteAccount(){
  if(!currentUser) return;
  if(!confirm("æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  fetch(apiUrl + "?user=" + encodeURIComponent(currentUser) + "&mode=delete",{
    method:"POST",
    body:""
  }).then(()=> {
    alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    location.reload();
  });
}

function logout(){
  if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
    location.reload();
  }
}

function refreshHistory(){
  const list=document.getElementById("historyList");
  list.innerHTML="";
  history.slice().sort((a,b)=>b.time.localeCompare(a.time)).forEach(e=>{
    const row=document.createElement("tr");
    row.innerHTML=`<td>${e.time}</td><td>${e.used}</td><td>${e.added}</td><td>${e.total}</td><td>${e.total*5}</td>`;
    list.appendChild(row);
  });
}

function toggleSettings(show){
  document.getElementById("settingsPanel").style.display = show?"block":"none";
  document.getElementById("settingsBtn").style.display = show?"none":"inline-block";
  document.getElementById("closeSettingsBtn").style.display = show?"inline-block":"none";
}
</script>
</body>
</html>
